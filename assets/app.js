const ShortLink=(()=>{const base62='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';const base62Safe='23456789abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ';function randCode(len,safe){const chars=safe?base62Safe:base62;let s='';for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];return s;}function validUrl(u){try{new URL(u);return true;}catch(e){return false;}}async function fetchMappings(){const res=await fetch('assets/mappings.json?ts='+Date.now());if(!res.ok) throw new Error('无法加载 mappings.json');return await res.json();}async function verifyAdmin(pass){if(!pass) return false;const sha=await sha256Hex(pass);const target=(CONFIG.ADMIN_PASSWORD_HASH||'').toLowerCase();if(target.length===64){return sha===target;}return false;}async function createMapping({url,code,expiresAt,password,targets}){if(!validUrl(url)) throw new Error('无效的 URL');const now=new Date().toISOString();let c=code;if(!c){const len=Math.max(CONFIG.CODE_MIN_LEN,4);c=randCode(len,CONFIG.AVOID_AMBIGUOUS);}else{if(!/^[0-9A-Za-z_-]+$/.test(c)) throw new Error('短码仅允许数字/字母/下划线/连字符');}let passwordHash=null;if(password){passwordHash=await sha256Hex(password);}return{code:c,url,createdAt:now,expiresAt:expiresAt||null,passwordHash,targets:targets||{device:{mobile:null,desktop:null},locale:{}}};}return{createMapping,fetchMappings,verifyAdmin};})();