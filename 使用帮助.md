# GitHub Pages 短链系统使用帮助

本文档说明如何在本仓库的基础上部署、生成和维护短链接，并给出常见问题的排查方法。

## 1. 仓库结构概览

- `index.html`：纯静态短链生成器，可配合命令行工具自动写入 `assets/mappings.json`。
- `index.html`：纯静态短链生成器，生成后的 JSON 需要手动写入 `assets/mappings.json`。
- `admin.html`：离线管理工具，支持从本地或线上 `mappings.json` 导入、编辑、导出。
- `404.html`：部署在 GitHub Pages（或任意静态托管）后的统一跳转入口。
- `assets/`
  - `app.js`：生成短码、校验 URL、计算密码哈希的核心逻辑。
  - `config.js`：短码长度、字符集、安全选项与管理员密码哈希等配置。
  - `mappings.json`：短码与长链接的映射数据文件。
  - `utils.js`：通用工具函数（如 `sha256Hex`）。
- `server-python/` 与 `server-node/`：可扩展为动态读写的后端示例，目前仅提供占位文件。

## 2. 纯静态部署步骤

1. 将整个仓库上传到 GitHub，启用 GitHub Pages（分支选择 `main`，目录选择 `/root`）。
2. 确保 `404.html` 作为 Pages 的错误页/路由入口：访问 `https://<用户名>.github.io/<仓库名>/<短码>` 即会触发跳转逻辑。
3. 任何时候修改了 `assets/mappings.json`，记得同步提交并等待 Pages 刷新缓存（通常 1 分钟内）。

> **提示**：GitHub Pages 只缓存静态文件，如遇浏览器缓存问题，可在地址后加 `?ts=<时间戳>` 强制刷新。

## 3. 生成短链的推荐流程

1. 打开 `index.html`（建议通过本地开发服务器或部署后访问，避免 `file://` 环境导致部分浏览器禁用 `crypto.subtle`）。
2. 在“长链接 URL”中输入完整的 `https://` 或 `http://` 开头的地址。
3. “自定义短码”可留空以随机生成，也可手动输入（仅允许 `0-9A-Za-z_-`）。
4. 点击“生成”后，下方会输出 JSON 文本，例如：
   ```json
   {
     "code": "abc12",
     "url": "https://example.com",
     "createdAt": "2024-01-01T12:00:00Z",
     "expiresAt": null,
     "passwordHash": null,
     "targets": {
       "device": {"mobile": null, "desktop": null},
       "locale": {}
     }
   }
   ```
5. 将生成的对象追加到 `assets/mappings.json`（保持合法的 JSON 数组格式），或使用下文命令行工具直接写入；随后提交并部署。

> **注意**：生成器不会自动写文件，需要手动复制粘贴；若页面没有任何显示，请打开浏览器控制台查看错误。

## 4. 使用命令行工具自动维护映射

仓库提供 `tools/shortlink-cli.mjs`，基于 Node.js（v16+）即可使用：

```bash
# 新增短链（随机短码）
node tools/shortlink-cli.mjs add --url https://example.com

# 自定义短码并设置访问密码、终端/语言定向
node tools/shortlink-cli.mjs add --url https://example.com --code promo \
  --password secret123 --mobile https://m.example.com --locale zh-CN=https://cn.example.com

# 查看/删除短链
node tools/shortlink-cli.mjs list
node tools/shortlink-cli.mjs remove --code promo
```

常用参数：

- `--file`：指定映射文件路径，默认 `assets/mappings.json`。
- `--expires`：设置过期时间（ISO8601）。
- `--replace`：允许覆盖已存在的同名短码。

> 运行命令后会直接改写 JSON 文件，可在提交前通过 Git diff/静态服务器验证。

## 5. 管理 `mappings.json`
5. 将生成的对象追加到 `assets/mappings.json`（保持合法的 JSON 数组格式），提交并部署。

> **注意**：生成器不会自动写文件，需要手动复制粘贴；若页面没有任何显示，请打开浏览器控制台查看错误。

## 4. 管理 `mappings.json`

- **线上加载**：在已部署环境访问 `admin.html`，输入管理员密码（默认 `admin123`，对应哈希保存在 `assets/config.js`，请尽快修改）。点击“拉取 mappings.json”即可读取线上数据。
- **本地导入/导出**：可直接选择本地 JSON 文件导入，完成编辑后使用“导出”按钮下载更新的 `mappings.json`。
- **字段说明**：
  - `expiresAt`：ISO8601 时间戳，留空表示永久有效。
  - `passwordHash`：访问保护密码的 SHA-256 哈希，可通过“编辑”操作输入明文自动计算。
  - `targets.device.mobile/desktop`：按终端类型重定向。
  - `targets.locale`：按浏览器语言代码（如 `zh-CN`）重定向。

## 6. 常见问题排查
## 5. 常见问题排查

| 现象 | 排查步骤 |
| --- | --- |
| 点击“生成”无反应 | 1) 确认浏览器控制台是否报错；2) URL 必须是合法格式（含协议）；3) 若通过 `file://` 直接打开，某些浏览器会禁用 `crypto.subtle`，建议使用 `npx http-server` 或其他本地服务器访问；4) 确认未安装拦截脚本扩展。 |
| 跳转失败或仍停留在 404 页 | 1) `mappings.json` 是否包含对应 `code`；2) GitHub Pages 是否已刷新缓存；3) 浏览器是否命中旧缓存，可尝试 `Ctrl+F5` 或附加 `?ts=<时间戳>`。 |
| 需要修改管理员密码 | 使用在线工具或 `admin.html` 的“编辑”功能输入新密码，复制生成的 SHA-256 哈希，替换 `assets/config.js` 的 `ADMIN_PASSWORD_HASH`。 |

## 7. 扩展到动态后端（可选）
## 6. 扩展到动态后端（可选）

仓库内的 `server-node/server.js` 与 `server-python/app.py` 目前仅占位。若需后台写入 `mappings.json` 或使用数据库，可参考以下思路：

- Node.js：使用 Express + SQLite/Prisma 等存储短链映射，通过 API 暴露增删改查。
- Python：使用 Flask + SQLite/SQLAlchemy，实现与静态页面兼容的 API 协议。
- 无论哪种方式，都需在前端调整 `fetch` 请求指向后端接口，并处理鉴权。

## 8. 建议的工作流程
## 7. 建议的工作流程

1. 在本地使用版本控制（Git）编辑 `assets/mappings.json`。
2. 更新后运行一次 `python -m http.server 8000`（或任何静态服务器）检查跳转逻辑。
3. 部署到 GitHub Pages 并进行真实访问测试。
4. 定期备份 `mappings.json`，避免误删导致短链失效。

如仍遇到无法生成或跳转的问题，请将浏览器控制台信息和当前 `mappings.json` 内容整理后再行排查。
